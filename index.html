<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WikiPath - Connect the Pages</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f6f6f6;
            min-height: 100vh;
        }

        .game-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .game-header.daily-mode {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .game-header h1 {
            font-size: 1.5em;
            margin-bottom: 3px;
            text-align: center;
        }

        .version {
            text-align: center;
            font-size: 0.7em;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        /* Mode Selector */
        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .mode-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mode-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .mode-btn.active {
            background: rgba(255,255,255,0.4);
            border-color: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(255,255,255,0.3);
        }

        .daily-indicator {
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.75em;
            text-align: center;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .daily-indicator .emoji {
            font-size: 1.2em;
        }

        .game-info {
            display: flex;
            justify-content: space-around;
            max-width: 1200px;
            margin: 0 auto;
            flex-wrap: wrap;
            gap: 10px;
        }

        .info-box {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 8px;
            text-align: center;
            min-width: 140px;
            position: relative;
            transition: all 0.3s ease;
        }

        .info-box:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .info-box .label {
            font-size: 0.75em;
            opacity: 0.9;
            margin-bottom: 3px;
        }

        .info-box .value {
            font-size: 1.2em;
            font-weight: bold;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        #target-page-display {
            font-size: 0.9em;
            line-height: 1.2;
        }

        .target-description {
            font-size: 0.65em;
            font-weight: normal;
            opacity: 0.9;
            margin-top: 3px;
            line-height: 1.2;
            font-style: italic;
        }

        /* Target Page Hover Details */
        .target-tooltip {
            display: none;
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 10px;
            background: white;
            color: #333;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 300px;
            max-width: 400px;
            text-align: left;
        }

        .info-box:hover .target-tooltip {
            display: block;
        }

        .target-tooltip::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid white;
        }

        .target-tooltip h4 {
            margin-bottom: 8px;
            color: #667eea;
            font-size: 1em;
        }

        .target-tooltip p {
            font-size: 0.9em;
            line-height: 1.5;
            color: #555;
        }

        /* Visual Path Display */
        .path-display {
            background: rgba(255,255,255,0.15);
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .path-display-title {
            font-size: 0.8em;
            opacity: 0.9;
            margin-bottom: 8px;
            text-align: center;
        }

        .path-chain {
            display: flex;
            align-items: center;
            gap: 8px;
            overflow-x: auto;
            padding: 5px 0;
            justify-content: center;
            flex-wrap: wrap;
        }

        .path-item-visual {
            background: rgba(255,255,255,0.3);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75em;
            white-space: nowrap;
            transition: all 0.2s ease;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .path-item-visual:hover {
            background: rgba(255,255,255,0.5);
            max-width: none;
        }

        .path-item-visual.current {
            background: rgba(255,255,255,0.5);
            font-weight: bold;
            border: 2px solid rgba(255,255,255,0.8);
        }

        .path-arrow {
            font-size: 0.8em;
            opacity: 0.7;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            position: relative;
        }

        /* Table of Contents */
        .toc-container {
            width: 250px;
            background: #f8f9fa;
            border-right: 1px solid #a2a9b1;
            padding: 20px;
            position: sticky;
            top: 0;
            height: calc(100vh - 200px);
            overflow-y: auto;
            flex-shrink: 0;
        }

        .toc-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #a2a9b1;
            color: #202122;
        }

        .toc-list {
            list-style: none;
        }

        .toc-item {
            margin-bottom: 8px;
        }

        .toc-link {
            color: #0645ad;
            text-decoration: none;
            font-size: 0.9em;
            display: block;
            padding: 4px 0;
            cursor: pointer;
            line-height: 1.4;
        }

        .toc-link:hover {
            text-decoration: underline;
        }

        .toc-link.active {
            font-weight: bold;
            color: #0b0080;
        }

        /* Main content area */
        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .wikipedia-article {
            font-family: 'Linux Libertine', Georgia, Times, serif;
            font-size: 14px;
            line-height: 1.6;
            color: #202122;
        }

        .wikipedia-article h1 {
            font-size: 2em;
            margin-bottom: 0.5em;
            padding-bottom: 0.3em;
            border-bottom: 1px solid #a2a9b1;
            font-family: 'Linux Libertine', Georgia, Times, serif;
        }

        .wikipedia-article h2 {
            font-size: 1.5em;
            margin-top: 1em;
            margin-bottom: 0.5em;
            padding-bottom: 0.2em;
            border-bottom: 1px solid #a2a9b1;
        }

        .wikipedia-article h3 {
            font-size: 1.2em;
            margin-top: 0.8em;
            margin-bottom: 0.4em;
        }

        .wikipedia-article p {
            margin-bottom: 0.8em;
        }

        .wikipedia-article a {
            color: #0645ad;
            text-decoration: none;
        }

        .wikipedia-article a:hover {
            text-decoration: underline;
        }

        .wikipedia-article a.visited-link {
            color: #0b0080;
        }

        .wikipedia-article a.disambiguation-link {
            color: #dd3333;
            font-style: italic;
        }

        .wikipedia-article ul, .wikipedia-article ol {
            margin-left: 1.6em;
            margin-bottom: 0.8em;
        }

        .wikipedia-article img {
            max-width: 100%;
            height: auto;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #666;
        }

        .error {
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 4px;
            padding: 20px;
            margin: 20px 0;
            color: #c00;
        }

        /* Win Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 40px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 20px;
            text-align: center;
        }

        .win-stats {
            background: #f0f0f0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-weight: bold;
            color: #555;
        }

        .stat-value {
            color: #667eea;
            font-weight: bold;
            font-size: 1.1em;
        }

        .win-path {
            margin: 20px 0;
        }

        .win-path h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .path-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            margin: 5px 0;
            background: #f8f8f8;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }

        .path-item-number {
            background: #667eea;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            font-weight: bold;
            flex-shrink: 0;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .modal-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .modal-btn.secondary {
            background: #f0f0f0;
            color: #333;
        }

        .modal-btn.secondary:hover {
            background: #e0e0e0;
        }

        .share-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 2000;
        }

        .share-notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .toc-container {
                width: 100%;
                height: auto;
                max-height: 200px;
                position: relative;
            }

            .content-area {
                padding: 20px;
            }

            .game-info {
                gap: 8px;
            }

            .info-box {
                min-width: 100px;
                font-size: 0.9em;
            }

            .path-chain {
                justify-content: flex-start;
            }

            .modal-content {
                padding: 20px;
                margin: 20px;
                max-width: 90%;
            }

            .mode-selector {
                flex-direction: column;
                gap: 8px;
            }

            .mode-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="game-header" id="game-header">
        <h1>üåê WikiPath</h1>
        <div class="version">v2.1.0 - Daily Challenge Edition</div>
        
        <!-- Mode Selector -->
        <div class="mode-selector">
            <button class="mode-btn" id="random-mode-btn" onclick="switchToRandomMode()">
                <span>üé≤</span>
                <span>Random Challenge</span>
            </button>
            <button class="mode-btn active" id="daily-mode-btn" onclick="switchToDailyMode()">
                <span>üìÖ</span>
                <span>Daily Challenge</span>
            </button>
        </div>

        <!-- Daily Challenge Indicator -->
        <div class="daily-indicator" id="daily-indicator" style="display: none;">
            <span class="emoji">üóìÔ∏è</span>
            <span id="daily-date"></span>
        </div>

        <div class="game-info">
            <div class="info-box">
                <div class="label">Clicks</div>
                <div class="value" id="click-counter">0</div>
            </div>
            <div class="info-box">
                <div class="label">Time</div>
                <div class="value" id="timer">0:00</div>
            </div>
            <div class="info-box">
                <div class="label">Pages Visited</div>
                <div class="value" id="pages-visited">1</div>
            </div>
            <div class="info-box">
                <div class="label">Target Page</div>
                <div class="value">
                    <div id="target-page-display">Loading...</div>
                    <div class="target-description" id="target-description"></div>
                </div>
                <div class="target-tooltip" id="target-tooltip">
                    <h4 id="tooltip-title"></h4>
                    <p id="tooltip-description"></p>
                </div>
            </div>
        </div>

        <!-- Visual Path Display -->
        <div class="path-display">
            <div class="path-display-title">üó∫Ô∏è Your Journey</div>
            <div class="path-chain" id="path-chain"></div>
        </div>
    </div>

    <div class="container">
        <div class="toc-container" id="toc-container">
            <div class="toc-title">Contents</div>
            <ul class="toc-list" id="toc-list"></ul>
        </div>
        <div class="content-area" id="game-area">
            <div class="loading">Loading Wikipedia article...</div>
        </div>
    </div>

    <!-- Win Modal -->
    <div class="modal-overlay" id="win-modal">
        <div class="modal-content">
            <h2>üéâ Congratulations! üéâ</h2>
            <div class="win-stats">
                <div class="stat-row">
                    <span class="stat-label">Total Clicks:</span>
                    <span class="stat-value" id="final-clicks">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Time Taken:</span>
                    <span class="stat-value" id="final-time">0:00</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Pages Visited:</span>
                    <span class="stat-value" id="final-pages">0</span>
                </div>
            </div>
            <div class="win-path" id="win-path"></div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="retryGame()">üîÑ Retry</button>
                <button class="modal-btn primary" onclick="shareResult()">üì§ Share</button>
                <button class="modal-btn secondary" onclick="startNewGame()">üéÆ New Game</button>
            </div>
        </div>
    </div>

    <!-- Share Notification -->
    <div class="share-notification" id="share-notification">
        ‚úì Copied to clipboard!
    </div>

    <script>
        // ======================
        // DAILY CHALLENGE SYSTEM
        // ======================
        
        // Get today's date in YYYY-MM-DD format
        function getTodayDateString() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        // Simple seeded random number generator
        function seededRandom(seed) {
            let x = Math.sin(seed++) * 10000;
            return x - Math.floor(x);
        }

        // Convert date string to seed number
        function dateToSeed(dateString) {
            return dateString.split('-').map(Number).reduce((acc, val) => acc * 100 + val, 0);
        }

        // Get seeded random index from array
        function getSeededRandomIndex(array, seed, offset = 0) {
            const adjustedSeed = seed + offset;
            return Math.floor(seededRandom(adjustedSeed) * array.length);
        }

        // Popular Wikipedia pages pool
        const POPULAR_PAGES = [
            "Albert Einstein", "World War II", "United States", "Python (programming language)",
            "William Shakespeare", "Leonardo da Vinci", "Solar System", "DNA",
            "Ancient Rome", "Climate change", "Artificial intelligence", "The Beatles",
            "Moon", "Mars", "Isaac Newton", "Charles Darwin", "Quantum mechanics",
            "Renaissance", "French Revolution", "Industrial Revolution", "Tiger",
            "Lion", "Elephant", "Blue whale", "Amazon rainforest", "Mount Everest",
            "Pacific Ocean", "European Union", "United Nations", "Olympic Games",
            "Football", "Basketball", "Chess", "Guitar", "Piano", "Vincent van Gogh",
            "Pablo Picasso", "Mona Lisa", "Beethoven", "Mozart", "Star Wars",
            "Harry Potter", "The Lord of the Rings", "Game of Thrones", "Netflix",
            "Google", "Apple Inc.", "Microsoft", "Facebook", "Twitter",
            "COVID-19 pandemic", "Great Wall of China", "Eiffel Tower", "Statue of Liberty",
            "Pyramids of Giza", "Taj Mahal", "Machu Picchu", "Colosseum",
            "Democracy", "Capitalism", "Socialism", "Philosophy", "Psychology",
            "Mathematics", "Physics", "Chemistry", "Biology", "Medicine",
            "Internet", "Computer", "Smartphone", "Electric car", "Space exploration",
            "International Space Station", "Hubble Space Telescope", "Big Bang",
            "Black hole", "Galaxy", "Milky Way", "Sun", "Earth", "Jupiter",
            "Saturn", "Dinosaur", "Evolution", "Photosynthesis", "Periodic table",
            "Napoleon", "Julius Caesar", "Cleopatra", "Alexander the Great",
            "Genghis Khan", "Abraham Lincoln", "George Washington", "Martin Luther King Jr.",
            "Mahatma Gandhi", "Nelson Mandela", "Adolf Hitler", "Winston Churchill",
            "Coffee", "Tea", "Chocolate", "Pizza", "Sushi", "Pasta",
            "Rice", "Bread", "Potato", "Tomato", "Wine", "Beer",
            "New York City", "London", "Paris", "Tokyo", "Beijing",
            "Rome", "Athens", "Cairo", "Istanbul", "Moscow",
            "Amazon (company)", "Tesla, Inc.", "SpaceX", "NASA", "Nobel Prize"
        ];

        // ======================
        // GAME STATE
        // ======================
        const gameState = {
            startPage: '',
            targetPage: '',
            currentPage: '',
            clickCount: 0,
            totalClicks: 0,
            visitedPages: new Set(),
            path: [],
            startTime: null,
            elapsedTime: 0,
            isDailyMode: localStorage.getItem('wikipath_mode') === 'random' ? false : true,
            dailyDate: getTodayDateString(),
            startDescription: '',
            targetDescription: ''
        };

        // ======================
        // URL STATE MANAGEMENT
        // ======================
        function updateUrl(start, target, current, clicks, totalClicks, visited, path, startTime) {
            const params = new URLSearchParams();
            params.set('start', start);
            params.set('target', target);
            params.set('current', current);
            params.set('clicks', clicks);
            params.set('totalClicks', totalClicks);
            params.set('visited', visited.join(','));
            params.set('path', path.join(','));
            params.set('startTime', startTime);
            
            if (gameState.isDailyMode) {
                params.set('daily', gameState.dailyDate);
            }
            
            const newUrl = `${window.location.pathname}?${params.toString()}`;
            window.history.pushState({}, '', newUrl);
        }

        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                start: params.get('start'),
                target: params.get('target'),
                current: params.get('current'),
                clicks: parseInt(params.get('clicks')) || 0,
                totalClicks: parseInt(params.get('totalClicks')) || 0,
                visited: params.get('visited') ? params.get('visited').split(',') : [],
                path: params.get('path') ? params.get('path').split(',') : [],
                startTime: parseInt(params.get('startTime')) || Date.now(),
                daily: params.get('daily')
            };
        }

        function clearUrl() {
            window.history.pushState({}, '', window.location.pathname);
        }

        // ======================
        // MODE SWITCHING
        // ======================
        function switchToRandomMode() {
            gameState.isDailyMode = false;
            localStorage.setItem('wikipath_mode', 'random');
            updateModeUI();
            clearUrl();
            location.reload();
        }

        function switchToDailyMode() {
            gameState.isDailyMode = true;
            gameState.dailyDate = getTodayDateString();
            localStorage.setItem('wikipath_mode', 'daily');
            updateModeUI();
            clearUrl();
            location.reload();
        }

        function updateModeUI() {
            const header = document.getElementById('game-header');
            const randomBtn = document.getElementById('random-mode-btn');
            const dailyBtn = document.getElementById('daily-mode-btn');
            const dailyIndicator = document.getElementById('daily-indicator');
            const dailyDateEl = document.getElementById('daily-date');

            if (gameState.isDailyMode) {
                header.classList.add('daily-mode');
                randomBtn.classList.remove('active');
                dailyBtn.classList.add('active');
                dailyIndicator.style.display = 'flex';
                
                const date = new Date(gameState.dailyDate);
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                dailyDateEl.textContent = date.toLocaleDateString('en-US', options);
            } else {
                header.classList.remove('daily-mode');
                randomBtn.classList.add('active');
                dailyBtn.classList.remove('active');
                dailyIndicator.style.display = 'none';
            }
        }

        // ======================
        // WIKIPEDIA API
        // ======================
        async function fetchWikipediaPage(title) {
            const endpoint = 'https://en.wikipedia.org/w/api.php';
            const params = new URLSearchParams({
                action: 'parse',
                page: title,
                format: 'json',
                origin: '*',
                prop: 'text|sections',
                disabletoc: '1'
            });

            try {
                const response = await fetch(`${endpoint}?${params}`);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.info);
                }

                return data.parse;
            } catch (error) {
                console.error('Error fetching Wikipedia page:', error);
                throw error;
            }
        }

        async function fetchPageDescription(title) {
            const endpoint = 'https://en.wikipedia.org/w/api.php';
            const params = new URLSearchParams({
                action: 'query',
                titles: title,
                format: 'json',
                origin: '*',
                prop: 'extracts',
                exintro: true,
                explaintext: true,
                exsentences: 2
            });

            try {
                const response = await fetch(`${endpoint}?${params}`);
                const data = await response.json();
                const pages = data.query.pages;
                const pageId = Object.keys(pages)[0];
                
                if (pageId === '-1') {
                    return '';
                }
                
                return pages[pageId].extract || '';
            } catch (error) {
                console.error('Error fetching page description:', error);
                return '';
            }
        }

        async function getRandomWikipediaPage() {
            const randomIndex = Math.floor(Math.random() * POPULAR_PAGES.length);
            return POPULAR_PAGES[randomIndex];
        }

        async function getDailyWikipediaPages() {
            const seed = dateToSeed(gameState.dailyDate);
            
            // Get start page
            const startIndex = getSeededRandomIndex(POPULAR_PAGES, seed, 0);
            const startPage = POPULAR_PAGES[startIndex];
            
            // Get target page (different from start)
            let targetIndex;
            do {
                targetIndex = getSeededRandomIndex(POPULAR_PAGES, seed, 1000);
            } while (targetIndex === startIndex);
            const targetPage = POPULAR_PAGES[targetIndex];
            
            return { startPage, targetPage };
        }

        // ======================
        // GAME CONTROLLER
        // ======================
        class GameController {
            constructor() {
                this.gameArea = document.getElementById('game-area');
                this.clickCounter = document.getElementById('click-counter');
                this.timerDisplay = document.getElementById('timer');
                this.pagesVisited = document.getElementById('pages-visited');
                this.targetPageDisplay = document.getElementById('target-page-display');
                this.targetDescriptionDisplay = document.getElementById('target-description');
                this.pathChain = document.getElementById('path-chain');
                this.tocContainer = document.getElementById('toc-list');
                this.timerInterval = null;
            }

            async initialize() {
                // Check if resuming from URL
                const urlParams = getUrlParams();
                
                if (urlParams.start && urlParams.target) {
                    // Check if daily mode and date matches
                    if (urlParams.daily) {
                        gameState.isDailyMode = true;
                        gameState.dailyDate = urlParams.daily;
                        
                        // If it's a different day, start fresh daily challenge
                        if (urlParams.daily !== getTodayDateString()) {
                            gameState.dailyDate = getTodayDateString();
                            await this.startNewDailyChallenge();
                            return;
                        }
                    } else {
                        gameState.isDailyMode = false;
                    }
                    
                    // Resume existing game
                    gameState.startPage = urlParams.start;
                    gameState.targetPage = urlParams.target;
                    gameState.currentPage = urlParams.current || urlParams.start;
                    gameState.clickCount = urlParams.clicks;
                    gameState.totalClicks = urlParams.totalClicks;
                    gameState.visitedPages = new Set(urlParams.visited);
                    gameState.path = urlParams.path.length > 0 ? urlParams.path : [urlParams.start];
                    gameState.startTime = urlParams.startTime;
                    
                    updateModeUI();
                    
                    // Fetch descriptions
                    gameState.targetDescription = await fetchPageDescription(gameState.targetPage);
                    
                    this.updateDisplay();
                    this.updatePathDisplay();
                    this.startTimer();
                    await this.loadPage(gameState.currentPage);
                } else {
                    // Start new game based on mode
                    if (gameState.isDailyMode) {
                        await this.startNewDailyChallenge();
                    } else {
                        await this.startNewRandomGame();
                    }
                }
            }

            async startNewDailyChallenge() {
                const { startPage, targetPage } = await getDailyWikipediaPages();
                
                gameState.startPage = startPage;
                gameState.targetPage = targetPage;
                gameState.currentPage = startPage;
                gameState.clickCount = 0;
                gameState.totalClicks = 0;
                gameState.visitedPages = new Set([startPage]);
                gameState.path = [startPage];
                gameState.startTime = Date.now();
                
                updateModeUI();
                
                // Fetch descriptions
                gameState.targetDescription = await fetchPageDescription(targetPage);
                
                this.updateDisplay();
                this.updatePathDisplay();
                this.startTimer();
                
                updateUrl(
                    startPage,
                    targetPage,
                    startPage,
                    0,
                    0,
                    [startPage],
                    [startPage],
                    gameState.startTime
                );
                
                await this.loadPage(startPage);
            }

            async startNewRandomGame() {
                const startPage = await getRandomWikipediaPage();
                let targetPage;
                do {
                    targetPage = await getRandomWikipediaPage();
                } while (targetPage === startPage);

                gameState.startPage = startPage;
                gameState.targetPage = targetPage;
                gameState.currentPage = startPage;
                gameState.clickCount = 0;
                gameState.totalClicks = 0;
                gameState.visitedPages = new Set([startPage]);
                gameState.path = [startPage];
                gameState.startTime = Date.now();

                updateModeUI();

                // Fetch descriptions
                gameState.targetDescription = await fetchPageDescription(targetPage);

                this.updateDisplay();
                this.updatePathDisplay();
                this.startTimer();

                updateUrl(
                    startPage,
                    targetPage,
                    startPage,
                    0,
                    0,
                    [startPage],
                    [startPage],
                    gameState.startTime
                );

                await this.loadPage(startPage);
            }

            startTimer() {
                this.timerInterval = setInterval(() => {
                    const elapsed = Date.now() - gameState.startTime;
                    const seconds = Math.floor(elapsed / 1000);
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = seconds % 60;
                    this.timerDisplay.textContent = `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
                }, 1000);
            }

            stopTimer() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                }
            }

            updatePathDisplay() {
                this.pathChain.innerHTML = '';
                
                gameState.path.forEach((page, index) => {
                    if (index > 0) {
                        const arrow = document.createElement('span');
                        arrow.className = 'path-arrow';
                        arrow.textContent = '‚Üí';
                        this.pathChain.appendChild(arrow);
                    }
                    
                    const item = document.createElement('div');
                    item.className = 'path-item-visual';
                    if (index === gameState.path.length - 1) {
                        item.classList.add('current');
                    }
                    item.textContent = page;
                    item.title = page;
                    this.pathChain.appendChild(item);
                });
            }

            async loadPage(title) {
                this.gameArea.innerHTML = '<div class="loading">Loading Wikipedia article...</div>';
                this.tocContainer.innerHTML = '';

                try {
                    const pageData = await fetchWikipediaPage(title);
                    this.renderPage(pageData);
                    this.buildTableOfContents(pageData.sections);
                } catch (error) {
                    this.showError(`Failed to load page: ${error.message}`);
                }
            }

            buildTableOfContents(sections) {
                if (!sections || sections.length === 0) {
                    this.tocContainer.innerHTML = '<li style="color: #999; font-size: 0.9em;">No sections available</li>';
                    return;
                }

                this.tocContainer.innerHTML = '';
                
                sections.forEach(section => {
                    if (section.toclevel <= 2) {
                        const li = document.createElement('li');
                        li.className = 'toc-item';
                        
                        const link = document.createElement('a');
                        link.className = 'toc-link';
                        link.textContent = section.line;
                        link.style.paddingLeft = `${(section.toclevel - 1) * 15}px`;
                        
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const heading = document.getElementById(section.anchor);
                            if (heading) {
                                heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                
                                document.querySelectorAll('.toc-link').forEach(l => l.classList.remove('active'));
                                link.classList.add('active');
                            }
                        });
                        
                        li.appendChild(link);
                        this.tocContainer.appendChild(li);
                    }
                });
            }

            renderPage(pageData) {
                const articleDiv = document.createElement('div');
                articleDiv.className = 'wikipedia-article';
                articleDiv.innerHTML = pageData.text['*'];

                this.gameArea.innerHTML = '';
                this.gameArea.appendChild(articleDiv);

                this.processLinks();
            }

            processLinks() {
                const links = this.gameArea.querySelectorAll('a');
                
                links.forEach(link => {
                    const href = link.getAttribute('href');
                    
                    if (href && href.startsWith('/wiki/') && !href.includes(':')) {
                        const pageTitle = decodeURIComponent(href.replace('/wiki/', ''));
                        
                        link.removeAttribute('href');
                        link.style.cursor = 'pointer';
                        
                        if (pageTitle.includes('(disambiguation)') || 
                            link.textContent.toLowerCase().includes('disambiguation')) {
                            link.classList.add('disambiguation-link');
                        }
                        
                        link.addEventListener('click', async (e) => {
                            e.preventDefault();
                            
                            if (link.classList.contains('disambiguation-link')) {
                                const confirmed = confirm(`‚ö†Ô∏è WARNING: "${pageTitle}" appears to be a disambiguation page.\n\nDisambiguation pages don't contain actual content - they just list links to other articles with similar names.\n\nDo you want to continue?`);
                                
                                if (!confirmed) {
                                    return;
                                }
                            }
                            
                            this.handleLinkClick(pageTitle);
                        });
                    } else {
                        link.style.color = '#999';
                        link.style.cursor = 'not-allowed';
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                        });
                    }
                });
            }

            async handleLinkClick(pageTitle) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                const isNewPage = !gameState.visitedPages.has(pageTitle);
                
                if (isNewPage) {
                    gameState.totalClicks++;
                    gameState.visitedPages.add(pageTitle);
                }
                
                gameState.clickCount++;
                gameState.currentPage = pageTitle;
                gameState.path.push(pageTitle);
                
                updateUrl(
                    gameState.startPage,
                    gameState.targetPage,
                    gameState.currentPage,
                    gameState.clickCount,
                    gameState.totalClicks,
                    Array.from(gameState.visitedPages),
                    gameState.path,
                    gameState.startTime
                );
                
                this.updateDisplay();
                this.updatePathDisplay();

                const normalizedCurrent = pageTitle.trim().toLowerCase().replace(/_/g, ' ');
                const normalizedTarget = gameState.targetPage.trim().toLowerCase().replace(/_/g, ' ');
                
                if (normalizedCurrent === normalizedTarget) {
                    this.showWinScreen();
                    return;
                }

                await this.loadPage(pageTitle);
            }

            updateDisplay() {
                this.clickCounter.textContent = gameState.totalClicks;
                this.pagesVisited.textContent = gameState.path.length;
                this.targetPageDisplay.textContent = gameState.targetPage;
                
                // Update target description
                if (gameState.targetDescription) {
                    this.targetDescriptionDisplay.textContent = gameState.targetDescription.substring(0, 100) + '...';
                    
                    // Update tooltip
                    document.getElementById('tooltip-title').textContent = gameState.targetPage;
                    document.getElementById('tooltip-description').textContent = gameState.targetDescription;
                }
            }

            showWinScreen() {
                this.stopTimer();
                
                const modal = document.getElementById('win-modal');
                const finalClicksEl = document.getElementById('final-clicks');
                const finalTimeEl = document.getElementById('final-time');
                const finalPagesEl = document.getElementById('final-pages');
                const winPathEl = document.getElementById('win-path');

                finalClicksEl.textContent = gameState.totalClicks;
                finalTimeEl.textContent = this.timerDisplay.textContent;
                finalPagesEl.textContent = gameState.path.length;

                let pathHtml = '<h3>üó∫Ô∏è Your Journey:</h3>';
                gameState.path.forEach((page, index) => {
                    pathHtml += `<div class="path-item">
                        <div class="path-item-number">${index + 1}</div>
                        <div>${page}</div>
                    </div>`;
                });
                winPathEl.innerHTML = pathHtml;

                modal.classList.add('active');
            }

            showError(message) {
                this.gameArea.innerHTML = `<div class="error">${message}</div>`;
            }
        }

        // ======================
        // SHARE FUNCTIONALITY
        // ======================
        function generateShareText() {
            const emoji = gameState.totalClicks <= 3 ? 'üèÜ' : gameState.totalClicks <= 5 ? 'üåü' : gameState.totalClicks <= 10 ? 'üëç' : '‚úÖ';
            
            let modeText = '';
            if (gameState.isDailyMode) {
                const date = new Date(gameState.dailyDate);
                const options = { month: 'short', day: 'numeric', year: 'numeric' };
                modeText = `üìÖ Daily Challenge - ${date.toLocaleDateString('en-US', options)}\n`;
            } else {
                modeText = `üé≤ Random Challenge\n`;
            }
            
            return `${emoji} WikiPath ${emoji}
${modeText}
From: ${gameState.startPage}
To: ${gameState.targetPage}

‚úì Clicks: ${gameState.totalClicks}
‚è±Ô∏è Time: ${game.timerDisplay.textContent}
üìÑ Pages: ${gameState.path.length}

Path: ${gameState.path.join(' ‚Üí ')}

Play at: ${window.location.origin}${window.location.pathname}`;
        }

        function shareResult() {
            const shareText = generateShareText();
            
            if (navigator.share) {
                navigator.share({
                    title: 'WikiPath Challenge',
                    text: shareText
                }).catch(err => {
                    console.log('Error sharing:', err);
                    copyResultToClipboard();
                });
            } else {
                copyResultToClipboard();
            }
        }

        function copyResultToClipboard() {
            const shareText = generateShareText();
            
            navigator.clipboard.writeText(shareText).then(() => {
                showNotification();
            }).catch(err => {
                console.error('Failed to copy:', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = shareText;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showNotification();
                } catch (err) {
                    console.error('Fallback copy failed:', err);
                }
                document.body.removeChild(textArea);
            });
        }

        function showNotification() {
            const notification = document.getElementById('share-notification');
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ======================
        // BROWSER BACK BUTTON HANDLER
        // ======================
        window.addEventListener('popstate', function(event) {
            const urlParams = getUrlParams();
            
            if (urlParams.start && urlParams.target) {
                // Check if daily mode and date matches
                if (urlParams.daily) {
                    gameState.isDailyMode = true;
                    gameState.dailyDate = urlParams.daily;
                    
                    if (urlParams.daily !== getTodayDateString()) {
                        location.reload();
                        return;
                    }
                } else {
                    gameState.isDailyMode = false;
                }
                
                gameState.startPage = urlParams.start;
                gameState.targetPage = urlParams.target;
                gameState.currentPage = urlParams.current || urlParams.start;
                gameState.clickCount = urlParams.clicks;
                gameState.totalClicks = Math.max(gameState.totalClicks, urlParams.totalClicks);
                gameState.visitedPages = new Set(urlParams.visited);
                gameState.path = urlParams.path.length > 0 ? urlParams.path : [urlParams.start];
                
                updateModeUI();
                game.updateDisplay();
                game.updatePathDisplay();
                game.loadPage(gameState.currentPage);
            }
        });

        // ======================
        // INITIALIZE GAME
        // ======================
        const game = new GameController();
        game.initialize();

        function startNewGame() {
            clearUrl();
            location.reload();
        }

        function retryGame() {
            if (!gameState.startPage || !gameState.targetPage) {
                return;
            }
            
            const start = gameState.startPage;
            const target = gameState.targetPage;
            
            gameState.currentPage = start;
            gameState.clickCount = 0;
            gameState.totalClicks = 0;
            gameState.visitedPages = new Set([start]);
            gameState.path = [start];
            gameState.startTime = Date.now();
            gameState.elapsedTime = 0;
            
            updateUrl(
                start,
                target,
                start,
                0,
                0,
                [start],
                [start],
                gameState.startTime
            );
            
            location.reload();
        }
    </script>
</body>
</html>
