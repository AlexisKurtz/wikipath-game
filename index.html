<!DOCTYPE html>
<html lang="en">
<!--
    WikiPath - Wikipedia Navigation Game
    Version: 3.0.0
    Last Updated: 2024-11-30
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WikiPath - Connect the Pages</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
        }

        /* Compact Header */
        .game-header {
            background: white;
            color: #202122;
            padding: 12px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            border-bottom: 3px solid #0645ad;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            gap: 20px;
            flex-wrap: wrap;
        }

        .game-branding {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .game-branding h1 {
            font-size: 1.4em;
            color: #0645ad;
            font-weight: 600;
        }

        .game-branding .logo {
            font-size: 1.8em;
        }

        /* Compact Mode Toggle */
        .mode-toggle {
            display: flex;
            background: #f0f0f0;
            border-radius: 20px;
            padding: 3px;
            gap: 3px;
        }

        .mode-toggle-btn {
            background: transparent;
            border: none;
            color: #666;
            padding: 6px 16px;
            border-radius: 17px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .mode-toggle-btn:hover {
            background: rgba(6, 69, 173, 0.1);
        }

        .mode-toggle-btn.active {
            background: #0645ad;
            color: white;
        }

        /* Compact Stats Bar */
        .stats-bar {
            display: flex;
            gap: 25px;
            align-items: center;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .stat-item.target {
            flex: 1;
            min-width: 200px;
        }

        .stat-label {
            font-size: 0.7em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 1.1em;
            font-weight: 700;
            color: #202122;
        }

        .stat-value.highlight {
            color: #0645ad;
            font-size: 1.2em;
        }

        #target-page-display {
            font-size: 1em;
            line-height: 1.2;
            color: #0645ad;
            font-weight: 700;
        }

        /* Difficulty Badge */
        .difficulty-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.65em;
            font-weight: 700;
            margin-left: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .difficulty-easy {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1.5px solid #4caf50;
        }

        .difficulty-medium {
            background: #fff3e0;
            color: #e65100;
            border: 1.5px solid #ff9800;
        }

        .difficulty-hard {
            background: #ffebee;
            color: #c62828;
            border: 1.5px solid #f44336;
        }

        .difficulty-expert {
            background: #f3e5f5;
            color: #6a1b9a;
            border: 1.5px solid #9c27b0;
        }

        /* Settings Menu */
        .settings-menu {
            position: relative;
        }

        .settings-btn {
            background: #f0f0f0;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-btn:hover {
            background: #e0e0e0;
        }

        /* Collapsible Path Panel */
        .path-panel {
            position: fixed;
            right: -350px;
            top: 0;
            width: 350px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            z-index: 200;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .path-panel.open {
            right: 0;
        }

        .path-panel-header {
            background: #0645ad;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .path-panel-header h3 {
            font-size: 1.1em;
        }

        .path-panel-close {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .path-panel-close:hover {
            background: rgba(255,255,255,0.2);
        }

        .path-panel-content {
            padding: 20px;
        }

        .path-timeline {
            position: relative;
            padding-left: 30px;
        }

        .path-timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #e0e0e0;
        }

        .path-timeline-item {
            position: relative;
            margin-bottom: 20px;
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #0645ad;
        }

        .path-timeline-item.current {
            background: #e3f2fd;
            border-left-color: #1976d2;
            border-left-width: 4px;
        }

        .path-timeline-item::before {
            content: '';
            position: absolute;
            left: -34px;
            top: 15px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #0645ad;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #e0e0e0;
        }

        .path-timeline-item.current::before {
            background: #1976d2;
            width: 16px;
            height: 16px;
            left: -36px;
            top: 13px;
        }

        .path-item-number {
            font-size: 0.75em;
            color: #666;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .path-item-title {
            font-size: 0.95em;
            color: #202122;
            font-weight: 500;
        }

        /* Floating Action Buttons */
        .fab-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 150;
        }

        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        .fab-primary {
            background: #0645ad;
            color: white;
        }

        .fab-secondary {
            background: white;
            color: #666;
            border: 2px solid #e0e0e0;
        }

        .fab-danger {
            background: #f44336;
            color: white;
        }

        .fab-tooltip {
            position: absolute;
            right: 70px;
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .fab:hover .fab-tooltip {
            opacity: 1;
        }

        /* Container with TOC */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            min-height: calc(100vh - 80px);
            display: flex;
            position: relative;
        }

        /* Table of Contents (KEPT) */
        .toc-container {
            width: 250px;
            background: #f8f9fa;
            border-right: 1px solid #e0e0e0;
            padding: 20px;
            position: sticky;
            top: 80px;
            height: calc(100vh - 80px);
            overflow-y: auto;
            flex-shrink: 0;
        }

        .toc-title {
            font-weight: 700;
            font-size: 1em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #0645ad;
            color: #202122;
        }

        .toc-list {
            list-style: none;
        }

        .toc-item {
            margin-bottom: 8px;
        }

        .toc-link {
            color: #0645ad;
            text-decoration: none;
            font-size: 0.9em;
            display: block;
            padding: 5px 0;
            cursor: pointer;
            line-height: 1.4;
            transition: color 0.2s;
        }

        .toc-link:hover {
            color: #0b0080;
            text-decoration: underline;
        }

        .toc-link.active {
            font-weight: 700;
            color: #0b0080;
        }

        /* Main content area */
        .content-area {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }

        .wikipedia-article {
            font-family: 'Linux Libertine', Georgia, Times, serif;
            font-size: 14px;
            line-height: 1.6;
            color: #202122;
            max-width: 900px;
        }

        .wikipedia-article h1 {
            font-size: 2em;
            margin-bottom: 0.5em;
            padding-bottom: 0.3em;
            border-bottom: 1px solid #a2a9b1;
            font-family: 'Linux Libertine', Georgia, Times, serif;
        }

        .wikipedia-article h2 {
            font-size: 1.5em;
            margin-top: 1em;
            margin-bottom: 0.5em;
            padding-bottom: 0.2em;
            border-bottom: 1px solid #a2a9b1;
        }

        .wikipedia-article h3 {
            font-size: 1.2em;
            margin-top: 0.8em;
            margin-bottom: 0.4em;
        }

        .wikipedia-article p {
            margin-bottom: 0.8em;
        }

        .wikipedia-article a {
            color: #0645ad;
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s;
        }

        .wikipedia-article a:hover {
            text-decoration: underline;
        }

        .wikipedia-article a.visited-link {
            color: #0b0080;
            opacity: 0.8;
        }

        .wikipedia-article a.disambiguation-link {
            color: #dd3333;
            font-style: italic;
        }

        .wikipedia-article ul, .wikipedia-article ol {
            margin-left: 1.6em;
            margin-bottom: 0.8em;
        }

        .wikipedia-article img {
            max-width: 100%;
            height: auto;
        }

        .loading {
            text-align: center;
            padding: 60px 40px;
            font-size: 1.1em;
            color: #666;
        }

        .loading::before {
            content: '‚è≥';
            font-size: 2em;
            display: block;
            margin-bottom: 15px;
        }

        .error {
            background: #ffebee;
            border: 1px solid #f44336;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            color: #c62828;
        }

        /* Win Modal - Improved */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.75);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 650px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalSlideIn {
            from {
                transform: scale(0.8) translateY(-50px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .modal-content h2 {
            color: #0645ad;
            font-size: 2.2em;
            margin-bottom: 25px;
            text-align: center;
        }

        .win-stats {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
            border: 2px solid #e0e0e0;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-weight: 600;
            color: #555;
            font-size: 1em;
        }

        .stat-value {
            color: #0645ad;
            font-weight: 700;
            font-size: 1.2em;
        }

        .win-path {
            margin: 25px 0;
        }

        .win-path h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.3em;
        }

        .path-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #0645ad;
            transition: all 0.2s;
        }

        .path-item:hover {
            background: #e3f2fd;
            transform: translateX(5px);
        }

        .path-item-number {
            background: #0645ad;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            font-weight: 700;
            flex-shrink: 0;
        }

        .performance-rating {
            background: #f0f0f0;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 25px;
            border: 3px solid;
        }

        .rating-perfect {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
            border-color: #FF8C00;
        }

        .rating-excellent {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border-color: #2e7d32;
        }

        .rating-good {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            border-color: #0d47a1;
        }

        .rating-completed {
            background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
            color: white;
            border-color: #4a148c;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 25px;
        }

        .modal-btn {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.2s ease;
        }

        .modal-btn.primary {
            background: #0645ad;
            color: white;
        }

        .modal-btn.primary:hover {
            background: #0b0080;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(6, 69, 173, 0.3);
        }

        .modal-btn.secondary {
            background: #f0f0f0;
            color: #333;
        }

        .modal-btn.secondary:hover {
            background: #e0e0e0;
        }

        .share-notification {
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 2000;
            font-weight: 600;
        }

        .share-notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Search Overlay */
        .search-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            justify-content: center;
            align-items: flex-start;
            padding-top: 100px;
        }

        .search-overlay.active {
            display: flex;
        }

        .search-box {
            background: white;
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .search-input {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.1em;
            border: 2px solid #0645ad;
            border-radius: 8px;
            outline: none;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            border-color: #0b0080;
        }

        .search-results {
            margin-top: 20px;
            max-height: 450px;
            overflow-y: auto;
        }

        .search-result-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
            border-radius: 6px;
        }

        .search-result-item:hover {
            background: #f8f9fa;
        }

        .search-result-item strong {
            color: #0645ad;
            font-weight: 700;
        }

        .search-hint {
            text-align: center;
            color: #999;
            font-size: 0.9em;
            margin-top: 15px;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .toc-container {
                width: 100%;
                height: auto;
                max-height: 200px;
                position: relative;
                top: 0;
            }

            .content-area {
                padding: 20px;
            }

            .header-top {
                gap: 10px;
            }

            .stats-bar {
                gap: 15px;
                font-size: 0.9em;
            }

            .path-panel {
                width: 100%;
                right: -100%;
            }

            .fab-container {
                bottom: 15px;
                right: 15px;
            }

            .fab {
                width: 50px;
                height: 50px;
            }

            .modal-content {
                padding: 25px;
                margin: 20px;
                max-width: 95%;
            }

            .modal-buttons {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .game-branding h1 {
                font-size: 1.1em;
            }

            .stat-value {
                font-size: 0.95em;
            }

            .stat-label {
                font-size: 0.65em;
            }
        }
    </style>
</head>
<body>
    <div class="game-header" id="game-header">
        <div class="header-top">
            <div class="game-branding">
                <span class="logo">üåê</span>
                <h1>WikiPath <span style="font-size: 0.5em; color: #666; font-weight: 400;">v3.0.0</span></h1>
            </div>

            <div class="mode-toggle">
                <button class="mode-toggle-btn" id="random-mode-btn" onclick="switchToRandomMode()">
                    üé≤ Random
                </button>
                <button class="mode-toggle-btn active" id="daily-mode-btn" onclick="switchToDailyMode()">
                    üìÖ Daily
                </button>
            </div>

            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-label">Clicks</div>
                    <div class="stat-value highlight" id="click-counter">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Time</div>
                    <div class="stat-value" id="timer">0:00</div>
                </div>
                <div class="stat-item target">
                    <div class="stat-label">Target Page</div>
                    <div>
                        <span id="target-page-display">Loading...</span>
                        <span class="difficulty-badge" id="difficulty-badge"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Path Panel (Collapsible) -->
    <div class="path-panel" id="path-panel">
        <div class="path-panel-header">
            <h3>üó∫Ô∏è Your Journey</h3>
            <button class="path-panel-close" onclick="togglePathPanel()">√ó</button>
        </div>
        <div class="path-panel-content">
            <div class="path-timeline" id="path-timeline"></div>
        </div>
    </div>

    <!-- Floating Action Buttons -->
    <div class="fab-container">
        <button class="fab fab-primary" onclick="togglePathPanel()" title="View Path">
            <span>üó∫Ô∏è</span>
            <span class="fab-tooltip">View Path</span>
        </button>
        <button class="fab fab-secondary" onclick="openSearch()" title="Search (Ctrl+F)">
            <span>üîç</span>
            <span class="fab-tooltip">Search (Ctrl+F)</span>
        </button>
        <button class="fab fab-danger" onclick="giveUp()" title="Give Up">
            <span>üè≥Ô∏è</span>
            <span class="fab-tooltip">Give Up</span>
        </button>
        <button class="fab fab-secondary" onclick="startNewGame()" title="New Game">
            <span>üéÆ</span>
            <span class="fab-tooltip">New Game</span>
        </button>
    </div>

    <div class="container">
        <div class="toc-container" id="toc-container">
            <div class="toc-title">Contents</div>
            <ul class="toc-list" id="toc-list"></ul>
        </div>
        <div class="content-area" id="game-area">
            <div class="loading">Loading Wikipedia article...</div>
        </div>
    </div>

    <!-- Win Modal -->
    <div class="modal-overlay" id="win-modal">
        <div class="modal-content">
            <h2>üéâ Congratulations! üéâ</h2>
            <div class="win-stats">
                <div class="stat-row">
                    <span class="stat-label">Total Clicks:</span>
                    <span class="stat-value" id="final-clicks">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Time Taken:</span>
                    <span class="stat-value" id="final-time">0:00</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Pages Visited:</span>
                    <span class="stat-value" id="final-pages">0</span>
                </div>
            </div>
            <div class="win-path" id="win-path"></div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="retryGame()">üîÑ Retry</button>
                <button class="modal-btn primary" onclick="shareResult()">üì§ Share</button>
                <button class="modal-btn secondary" onclick="startNewGame()">üéÆ New Game</button>
            </div>
        </div>
    </div>

    <!-- Share Notification -->
    <div class="share-notification" id="share-notification">
        ‚úì Copied to clipboard!
    </div>

    <!-- Search Overlay (Ctrl+F) -->
    <div class="search-overlay" id="search-overlay">
        <div class="search-box">
            <input type="text" class="search-input" id="search-input" placeholder="Search within current article...">
            <div class="search-results" id="search-results"></div>
            <div class="search-hint">Press Ctrl+F to search ‚Ä¢ ESC to close</div>
        </div>
    </div>

    <script>
        // ======================
        // DAILY CHALLENGE SYSTEM
        // ======================
        
        // Get today's date in YYYY-MM-DD format
        function getTodayDateString() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        // Simple seeded random number generator
        function seededRandom(seed) {
            let x = Math.sin(seed++) * 10000;
            return x - Math.floor(x);
        }

        // Convert date string to seed number
        function dateToSeed(dateString) {
            return dateString.split('-').map(Number).reduce((acc, val) => acc * 100 + val, 0);
        }

        // Get seeded random index from array
        function getSeededRandomIndex(array, seed, offset = 0) {
            const adjustedSeed = seed + offset;
            return Math.floor(seededRandom(adjustedSeed) * array.length);
        }

        // Popular Wikipedia pages pool with difficulty ratings
        const POPULAR_PAGES = {
            easy: [
                "United States", "World War II", "Python (programming language)",
                "Solar System", "Moon", "Sun", "Earth", "Water",
                "Dog", "Cat", "Football", "Basketball", "Music",
                "Internet", "Google", "Apple Inc.", "Microsoft",
                "New York City", "London", "Paris", "Pizza", "Coffee"
            ],
            medium: [
                "Albert Einstein", "William Shakespeare", "Leonardo da Vinci",
                "DNA", "Climate change", "Artificial intelligence", "The Beatles",
                "Mars", "Isaac Newton", "Charles Darwin", "Quantum mechanics",
                "Renaissance", "French Revolution", "Industrial Revolution",
                "Tiger", "Lion", "Elephant", "Blue whale", "Amazon rainforest",
                "Mount Everest", "Pacific Ocean", "European Union", "United Nations",
                "Olympic Games", "Chess", "Guitar", "Piano", "Vincent van Gogh",
                "Pablo Picasso", "Mona Lisa", "Beethoven", "Mozart", "Star Wars",
                "Harry Potter", "The Lord of the Rings", "Facebook", "Twitter",
                "Great Wall of China", "Eiffel Tower", "Statue of Liberty",
                "Pyramids of Giza", "Taj Mahal", "Machu Picchu", "Colosseum"
            ],
            hard: [
                "Ancient Rome", "Democracy", "Capitalism", "Socialism",
                "Philosophy", "Psychology", "Mathematics", "Physics",
                "Chemistry", "Biology", "Medicine", "Computer", "Smartphone",
                "Electric car", "Space exploration", "International Space Station",
                "Hubble Space Telescope", "Big Bang", "Black hole", "Galaxy",
                "Milky Way", "Jupiter", "Saturn", "Dinosaur", "Evolution",
                "Photosynthesis", "Periodic table", "Napoleon", "Julius Caesar",
                "Cleopatra", "Alexander the Great", "Genghis Khan",
                "Abraham Lincoln", "George Washington", "Martin Luther King Jr.",
                "Mahatma Gandhi", "Nelson Mandela", "Winston Churchill"
            ],
            expert: [
                "COVID-19 pandemic", "Game of Thrones", "Netflix",
                "Chocolate", "Tea", "Sushi", "Pasta", "Rice", "Bread",
                "Potato", "Tomato", "Wine", "Beer", "Tokyo", "Beijing",
                "Rome", "Athens", "Cairo", "Istanbul", "Moscow",
                "Amazon (company)", "Tesla, Inc.", "SpaceX", "NASA", "Nobel Prize",
                "Adolf Hitler"
            ]
        };

        // Flatten for random selection
        const ALL_PAGES = [
            ...POPULAR_PAGES.easy,
            ...POPULAR_PAGES.medium,
            ...POPULAR_PAGES.hard,
            ...POPULAR_PAGES.expert
        ];

        // Get difficulty of a page
        function getPageDifficulty(pageName) {
            for (const [difficulty, pages] of Object.entries(POPULAR_PAGES)) {
                if (pages.includes(pageName)) {
                    return difficulty;
                }
            }
            return 'medium';
        }

        // Calculate overall challenge difficulty
        function calculateChallengeDifficulty(startPage, targetPage) {
            const startDiff = getPageDifficulty(startPage);
            const targetDiff = getPageDifficulty(targetPage);
            
            const difficultyScore = {
                'easy': 1,
                'medium': 2,
                'hard': 3,
                'expert': 4
            };
            
            const avgScore = (difficultyScore[startDiff] + difficultyScore[targetDiff]) / 2;
            
            if (avgScore <= 1.5) return 'easy';
            if (avgScore <= 2.5) return 'medium';
            if (avgScore <= 3.5) return 'hard';
            return 'expert';
        }

        // ======================
        // GAME STATE
        // ======================
        const gameState = {
            startPage: '',
            targetPage: '',
            currentPage: '',
            clickCount: 0,
            totalClicks: 0,
            visitedPages: new Set(),
            path: [],
            startTime: null,
            elapsedTime: 0,
            isDailyMode: localStorage.getItem('wikipath_mode') === 'random' ? false : true,
            dailyDate: getTodayDateString(),
            startDescription: '',
            targetDescription: '',
            hasWon: false,
            gaveUp: false,
            difficulty: 'medium'
        };

        // ======================
        // URL STATE MANAGEMENT
        // ======================
        function updateUrl(start, target, current, clicks, totalClicks, visited, path, startTime) {
            const params = new URLSearchParams();
            params.set('start', start);
            params.set('target', target);
            params.set('current', current);
            params.set('clicks', clicks);
            params.set('totalClicks', totalClicks);
            params.set('visited', visited.join(','));
            params.set('path', path.join(','));
            params.set('startTime', startTime);
            
            if (gameState.isDailyMode) {
                params.set('daily', gameState.dailyDate);
            }
            
            const newUrl = `${window.location.pathname}?${params.toString()}`;
            window.history.pushState({}, '', newUrl);
        }

        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                start: params.get('start'),
                target: params.get('target'),
                current: params.get('current'),
                clicks: parseInt(params.get('clicks')) || 0,
                totalClicks: parseInt(params.get('totalClicks')) || 0,
                visited: params.get('visited') ? params.get('visited').split(',') : [],
                path: params.get('path') ? params.get('path').split(',') : [],
                startTime: parseInt(params.get('startTime')) || Date.now(),
                daily: params.get('daily')
            };
        }

        function clearUrl() {
            window.history.pushState({}, '', window.location.pathname);
        }

        // ======================
        // MODE SWITCHING
        // ======================
        function switchToRandomMode() {
            gameState.isDailyMode = false;
            localStorage.setItem('wikipath_mode', 'random');
            updateModeUI();
            clearUrl();
            location.reload();
        }

        function switchToDailyMode() {
            gameState.isDailyMode = true;
            gameState.dailyDate = getTodayDateString();
            localStorage.setItem('wikipath_mode', 'daily');
            updateModeUI();
            clearUrl();
            location.reload();
        }

        function updateModeUI() {
            const header = document.getElementById('game-header');
            const randomBtn = document.getElementById('random-mode-btn');
            const dailyBtn = document.getElementById('daily-mode-btn');

            if (gameState.isDailyMode) {
                randomBtn.classList.remove('active');
                dailyBtn.classList.add('active');
            } else {
                randomBtn.classList.add('active');
                dailyBtn.classList.remove('active');
            }
        }

        // ======================
        // WIKIPEDIA API
        // ======================
        async function fetchWikipediaPage(title) {
            const endpoint = 'https://en.wikipedia.org/w/api.php';
            const params = new URLSearchParams({
                action: 'parse',
                page: title,
                format: 'json',
                origin: '*',
                prop: 'text|sections',
                disabletoc: '1'
            });

            try {
                const response = await fetch(`${endpoint}?${params}`);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.info);
                }

                return data.parse;
            } catch (error) {
                console.error('Error fetching Wikipedia page:', error);
                throw error;
            }
        }

        async function fetchPageDescription(title) {
            const endpoint = 'https://en.wikipedia.org/w/api.php';
            const params = new URLSearchParams({
                action: 'query',
                titles: title,
                format: 'json',
                origin: '*',
                prop: 'extracts',
                exintro: true,
                explaintext: true,
                exsentences: 2
            });

            try {
                const response = await fetch(`${endpoint}?${params}`);
                const data = await response.json();
                const pages = data.query.pages;
                const pageId = Object.keys(pages)[0];
                
                if (pageId === '-1') {
                    return '';
                }
                
                return pages[pageId].extract || '';
            } catch (error) {
                console.error('Error fetching page description:', error);
                return '';
            }
        }

        async function getRandomWikipediaPage() {
            const randomIndex = Math.floor(Math.random() * ALL_PAGES.length);
            return ALL_PAGES[randomIndex];
        }

        async function getDailyWikipediaPages() {
            const seed = dateToSeed(gameState.dailyDate);
            
            // Get start page
            const startIndex = getSeededRandomIndex(ALL_PAGES, seed, 0);
            const startPage = ALL_PAGES[startIndex];
            
            // Get target page (different from start)
            let targetIndex;
            do {
                targetIndex = getSeededRandomIndex(ALL_PAGES, seed, 1000);
            } while (targetIndex === startIndex);
            const targetPage = ALL_PAGES[targetIndex];
            
            return { startPage, targetPage };
        }

        // ======================
        // GAME CONTROLLER
        // ======================
        class GameController {
            constructor() {
                this.gameArea = document.getElementById('game-area');
                this.clickCounter = document.getElementById('click-counter');
                this.timerDisplay = document.getElementById('timer');
                this.targetPageDisplay = document.getElementById('target-page-display');
                this.tocContainer = document.getElementById('toc-list');
                this.timerInterval = null;
            }

            async initialize() {
                // Check if resuming from URL
                const urlParams = getUrlParams();
                
                if (urlParams.start && urlParams.target) {
                    // Check if daily mode and date matches
                    if (urlParams.daily) {
                        gameState.isDailyMode = true;
                        gameState.dailyDate = urlParams.daily;
                        
                        // If it's a different day, start fresh daily challenge
                        if (urlParams.daily !== getTodayDateString()) {
                            gameState.dailyDate = getTodayDateString();
                            await this.startNewDailyChallenge();
                            return;
                        }
                    } else {
                        gameState.isDailyMode = false;
                    }
                    
                    // Resume existing game
                    gameState.startPage = urlParams.start;
                    gameState.targetPage = urlParams.target;
                    gameState.currentPage = urlParams.current || urlParams.start;
                    gameState.clickCount = urlParams.clicks;
                    gameState.totalClicks = urlParams.totalClicks;
                    gameState.visitedPages = new Set(urlParams.visited);
                    gameState.path = urlParams.path.length > 0 ? urlParams.path : [urlParams.start];
                    gameState.startTime = urlParams.startTime;
                    
                    updateModeUI();
                    
                    // Fetch descriptions
                    gameState.targetDescription = await fetchPageDescription(gameState.targetPage);
                    
                    this.updateDisplay();
                    this.updatePathDisplay();
                    this.startTimer();
                    await this.loadPage(gameState.currentPage);
                } else {
                    // Start new game based on mode
                    if (gameState.isDailyMode) {
                        await this.startNewDailyChallenge();
                    } else {
                        await this.startNewRandomGame();
                    }
                }
            }

            async startNewDailyChallenge() {
                const { startPage, targetPage } = await getDailyWikipediaPages();
                
                gameState.startPage = startPage;
                gameState.targetPage = targetPage;
                gameState.currentPage = startPage;
                gameState.clickCount = 0;
                gameState.totalClicks = 0;
                gameState.visitedPages = new Set([startPage]);
                gameState.path = [startPage];
                gameState.startTime = Date.now();
                gameState.hasWon = false;
                gameState.gaveUp = false;
                gameState.difficulty = calculateChallengeDifficulty(startPage, targetPage);
                
                updateModeUI();
                
                // Fetch descriptions
                gameState.targetDescription = await fetchPageDescription(targetPage);
                
                this.updateDisplay();
                this.updatePathDisplay();
                this.startTimer();
                
                updateUrl(
                    startPage,
                    targetPage,
                    startPage,
                    0,
                    0,
                    [startPage],
                    [startPage],
                    gameState.startTime
                );
                
                await this.loadPage(startPage);
            }

            async startNewRandomGame() {
                const startPage = await getRandomWikipediaPage();
                let targetPage;
                do {
                    targetPage = await getRandomWikipediaPage();
                } while (targetPage === startPage);

                gameState.startPage = startPage;
                gameState.targetPage = targetPage;
                gameState.currentPage = startPage;
                gameState.clickCount = 0;
                gameState.totalClicks = 0;
                gameState.visitedPages = new Set([startPage]);
                gameState.path = [startPage];
                gameState.startTime = Date.now();
                gameState.hasWon = false;
                gameState.gaveUp = false;
                gameState.difficulty = calculateChallengeDifficulty(startPage, targetPage);

                updateModeUI();

                // Fetch descriptions
                gameState.targetDescription = await fetchPageDescription(targetPage);

                this.updateDisplay();
                this.updatePathDisplay();
                this.startTimer();

                updateUrl(
                    startPage,
                    targetPage,
                    startPage,
                    0,
                    0,
                    [startPage],
                    [startPage],
                    gameState.startTime
                );

                await this.loadPage(startPage);
            }

            startTimer() {
                this.timerInterval = setInterval(() => {
                    const elapsed = Date.now() - gameState.startTime;
                    const seconds = Math.floor(elapsed / 1000);
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = seconds % 60;
                    this.timerDisplay.textContent = `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
                }, 1000);
            }

            stopTimer() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                }
            }

            updatePathDisplay() {
                const pathTimeline = document.getElementById('path-timeline');
                pathTimeline.innerHTML = '';
                
                gameState.path.forEach((page, index) => {
                    const item = document.createElement('div');
                    item.className = 'path-timeline-item';
                    if (index === gameState.path.length - 1) {
                        item.classList.add('current');
                    }
                    
                    item.innerHTML = `
                        <div class="path-item-number">Step ${index + 1}</div>
                        <div class="path-item-title">${page}</div>
                    `;
                    
                    pathTimeline.appendChild(item);
                });
            }

            async loadPage(title) {
                this.gameArea.innerHTML = '<div class="loading">Loading Wikipedia article...</div>';
                this.tocContainer.innerHTML = '';

                try {
                    const pageData = await fetchWikipediaPage(title);
                    this.renderPage(pageData);
                    this.buildTableOfContents(pageData.sections);
                } catch (error) {
                    this.showError(`Failed to load page: ${error.message}`);
                }
            }

            buildTableOfContents(sections) {
                if (!sections || sections.length === 0) {
                    this.tocContainer.innerHTML = '<li style="color: #999; font-size: 0.9em;">No sections available</li>';
                    return;
                }

                this.tocContainer.innerHTML = '';
                
                sections.forEach(section => {
                    if (section.toclevel <= 2) {
                        const li = document.createElement('li');
                        li.className = 'toc-item';
                        
                        const link = document.createElement('a');
                        link.className = 'toc-link';
                        link.textContent = section.line;
                        link.style.paddingLeft = `${(section.toclevel - 1) * 15}px`;
                        
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const heading = document.getElementById(section.anchor);
                            if (heading) {
                                heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                
                                document.querySelectorAll('.toc-link').forEach(l => l.classList.remove('active'));
                                link.classList.add('active');
                            }
                        });
                        
                        li.appendChild(link);
                        this.tocContainer.appendChild(li);
                    }
                });
            }

            renderPage(pageData) {
                const articleDiv = document.createElement('div');
                articleDiv.className = 'wikipedia-article';
                articleDiv.innerHTML = pageData.text['*'];

                this.gameArea.innerHTML = '';
                this.gameArea.appendChild(articleDiv);

                this.processLinks();
            }

            processLinks() {
                const links = this.gameArea.querySelectorAll('a');
                
                links.forEach(link => {
                    const href = link.getAttribute('href');
                    
                    if (href && href.startsWith('/wiki/') && !href.includes(':')) {
                        const pageTitle = decodeURIComponent(href.replace('/wiki/', ''));
                        
                        link.removeAttribute('href');
                        link.style.cursor = 'pointer';
                        
                        if (pageTitle.includes('(disambiguation)') || 
                            link.textContent.toLowerCase().includes('disambiguation')) {
                            link.classList.add('disambiguation-link');
                        }
                        
                        link.addEventListener('click', async (e) => {
                            e.preventDefault();
                            
                            if (link.classList.contains('disambiguation-link')) {
                                const confirmed = confirm(`‚ö†Ô∏è WARNING: "${pageTitle}" appears to be a disambiguation page.\n\nDisambiguation pages don't contain actual content - they just list links to other articles with similar names.\n\nDo you want to continue?`);
                                
                                if (!confirmed) {
                                    return;
                                }
                            }
                            
                            this.handleLinkClick(pageTitle);
                        });
                    } else {
                        link.style.color = '#999';
                        link.style.cursor = 'not-allowed';
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                        });
                    }
                });
            }

            async handleLinkClick(pageTitle) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                const isNewPage = !gameState.visitedPages.has(pageTitle);
                
                if (isNewPage) {
                    gameState.totalClicks++;
                    gameState.visitedPages.add(pageTitle);
                }
                
                gameState.clickCount++;
                gameState.currentPage = pageTitle;
                gameState.path.push(pageTitle);
                
                updateUrl(
                    gameState.startPage,
                    gameState.targetPage,
                    gameState.currentPage,
                    gameState.clickCount,
                    gameState.totalClicks,
                    Array.from(gameState.visitedPages),
                    gameState.path,
                    gameState.startTime
                );
                
                this.updateDisplay();
                this.updatePathDisplay();

                const normalizedCurrent = pageTitle.trim().toLowerCase().replace(/_/g, ' ');
                const normalizedTarget = gameState.targetPage.trim().toLowerCase().replace(/_/g, ' ');
                
                if (normalizedCurrent === normalizedTarget) {
                    this.showWinScreen();
                    return;
                }

                await this.loadPage(pageTitle);
            }

            updateDisplay() {
                this.clickCounter.textContent = gameState.totalClicks;
                this.targetPageDisplay.textContent = gameState.targetPage;
                
                // Update difficulty badge
                const difficultyBadge = document.getElementById('difficulty-badge');
                difficultyBadge.textContent = gameState.difficulty.toUpperCase();
                difficultyBadge.className = `difficulty-badge difficulty-${gameState.difficulty}`;
            }

            showWinScreen() {
                this.stopTimer();
                gameState.hasWon = true;
                
                const modal = document.getElementById('win-modal');
                const finalClicksEl = document.getElementById('final-clicks');
                const finalTimeEl = document.getElementById('final-time');
                const finalPagesEl = document.getElementById('final-pages');
                const winPathEl = document.getElementById('win-path');

                finalClicksEl.textContent = gameState.totalClicks;
                finalTimeEl.textContent = this.timerDisplay.textContent;
                finalPagesEl.textContent = gameState.path.length;

                // Performance rating
                let rating = '';
                let ratingClass = '';
                if (gameState.totalClicks <= 3) {
                    rating = 'üèÜ AMAZING! Perfect score!';
                    ratingClass = 'rating-perfect';
                } else if (gameState.totalClicks <= 5) {
                    rating = 'üåü EXCELLENT! Great job!';
                    ratingClass = 'rating-excellent';
                } else if (gameState.totalClicks <= 10) {
                    rating = 'üëç GOOD! Well done!';
                    ratingClass = 'rating-good';
                } else {
                    rating = '‚úÖ COMPLETED! Nice work!';
                    ratingClass = 'rating-completed';
                }

                let pathHtml = `<div class="performance-rating ${ratingClass}">${rating}</div>`;
                pathHtml += '<h3>üó∫Ô∏è Your Journey:</h3>';
                gameState.path.forEach((page, index) => {
                    pathHtml += `<div class="path-item">
                        <div class="path-item-number">${index + 1}</div>
                        <div>${page}</div>
                    </div>`;
                });
                winPathEl.innerHTML = pathHtml;

                modal.classList.add('active');
            }

            showError(message) {
                this.gameArea.innerHTML = `<div class="error">${message}</div>`;
            }
        }

        // ======================
        // SHARE FUNCTIONALITY
        // ======================
        function generateShareText() {
            const emoji = gameState.totalClicks <= 3 ? 'üèÜ' : gameState.totalClicks <= 5 ? 'üåü' : gameState.totalClicks <= 10 ? 'üëç' : '‚úÖ';
            
            let modeText = '';
            if (gameState.isDailyMode) {
                const date = new Date(gameState.dailyDate);
                const options = { month: 'short', day: 'numeric', year: 'numeric' };
                modeText = `üìÖ Daily Challenge - ${date.toLocaleDateString('en-US', options)}\n`;
            } else {
                modeText = `üé≤ Random Challenge\n`;
            }
            
            return `${emoji} WikiPath ${emoji}
${modeText}
From: ${gameState.startPage}
To: ${gameState.targetPage}

‚úì Clicks: ${gameState.totalClicks}
‚è±Ô∏è Time: ${game.timerDisplay.textContent}
üìÑ Pages: ${gameState.path.length}

Path: ${gameState.path.join(' ‚Üí ')}

Play at: ${window.location.origin}${window.location.pathname}`;
        }

        function shareResult() {
            const shareText = generateShareText();
            
            if (navigator.share) {
                navigator.share({
                    title: 'WikiPath Challenge',
                    text: shareText
                }).catch(err => {
                    console.log('Error sharing:', err);
                    copyResultToClipboard();
                });
            } else {
                copyResultToClipboard();
            }
        }

        function copyResultToClipboard() {
            const shareText = generateShareText();
            
            navigator.clipboard.writeText(shareText).then(() => {
                showNotification();
            }).catch(err => {
                console.error('Failed to copy:', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = shareText;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showNotification();
                } catch (err) {
                    console.error('Fallback copy failed:', err);
                }
                document.body.removeChild(textArea);
            });
        }

        function showNotification() {
            const notification = document.getElementById('share-notification');
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ======================
        // BROWSER BACK BUTTON HANDLER
        // ======================
        window.addEventListener('popstate', function(event) {
            const urlParams = getUrlParams();
            
            if (urlParams.start && urlParams.target) {
                // Check if daily mode and date matches
                if (urlParams.daily) {
                    gameState.isDailyMode = true;
                    gameState.dailyDate = urlParams.daily;
                    
                    if (urlParams.daily !== getTodayDateString()) {
                        location.reload();
                        return;
                    }
                } else {
                    gameState.isDailyMode = false;
                }
                
                gameState.startPage = urlParams.start;
                gameState.targetPage = urlParams.target;
                gameState.currentPage = urlParams.current || urlParams.start;
                gameState.clickCount = urlParams.clicks;
                gameState.totalClicks = Math.max(gameState.totalClicks, urlParams.totalClicks);
                gameState.visitedPages = new Set(urlParams.visited);
                gameState.path = urlParams.path.length > 0 ? urlParams.path : [urlParams.start];
                
                updateModeUI();
                game.updateDisplay();
                game.updatePathDisplay();
                game.loadPage(gameState.currentPage);
            }
        });

        // ======================
        // PATH PANEL TOGGLE
        // ======================
        function togglePathPanel() {
            const panel = document.getElementById('path-panel');
            panel.classList.toggle('open');
        }

        // ======================
        // GIVE UP FUNCTIONALITY
        // ======================
        function giveUp() {
            const confirmed = confirm(`Are you sure you want to give up?\n\nThis will show you the target page but won't count as a win.`);
            
            if (!confirmed) {
                return;
            }
            
            game.stopTimer();
            gameState.gaveUp = true;
            
            const modal = document.getElementById('win-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <h2>üè≥Ô∏è Challenge Ended</h2>
                <div class="win-stats">
                    <div class="stat-row">
                        <span class="stat-label">You were trying to reach:</span>
                        <span class="stat-value">${gameState.targetPage}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Clicks Used:</span>
                        <span class="stat-value">${gameState.totalClicks}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Time Spent:</span>
                        <span class="stat-value">${game.timerDisplay.textContent}</span>
                    </div>
                </div>
                <div class="win-path">
                    <h3>üó∫Ô∏è Your Path So Far:</h3>
                    ${gameState.path.map((page, index) => `
                        <div class="path-item">
                            <div class="path-item-number">${index + 1}</div>
                            <div>${page}</div>
                        </div>
                    `).join('')}
                    <div style="text-align: center; margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; color: #856404;">
                        <strong>üí° Tip:</strong> Try exploring links related to broader categories or finding connections through related topics!
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn secondary" onclick="retryGame()">üîÑ Try Again</button>
                    <button class="modal-btn secondary" onclick="startNewGame()">üéÆ New Challenge</button>
                </div>
            `;
            
            modal.classList.add('active');
        }

        // ======================
        // SEARCH FUNCTIONALITY (Ctrl+F)
        // ======================
        let searchOverlay = null;
        let searchInput = null;
        let searchResults = null;

        function initializeSearch() {
            searchOverlay = document.getElementById('search-overlay');
            searchInput = document.getElementById('search-input');
            searchResults = document.getElementById('search-results');
            
            // Keyboard shortcut
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                    e.preventDefault();
                    openSearch();
                }
                
                if (e.key === 'Escape' && searchOverlay.classList.contains('active')) {
                    closeSearch();
                }
            });
            
            // Close on overlay click
            searchOverlay.addEventListener('click', (e) => {
                if (e.target === searchOverlay) {
                    closeSearch();
                }
            });
            
            // Search input handler
            searchInput.addEventListener('input', performSearch);
        }

        function openSearch() {
            searchOverlay.classList.add('active');
            searchInput.value = '';
            searchResults.innerHTML = '';
            searchInput.focus();
        }

        function closeSearch() {
            searchOverlay.classList.remove('active');
        }

        function performSearch() {
            const query = searchInput.value.toLowerCase().trim();
            searchResults.innerHTML = '';
            
            if (query.length < 2) {
                return;
            }
            
            const gameArea = document.getElementById('game-area');
            const allLinks = gameArea.querySelectorAll('a');
            const allText = gameArea.querySelectorAll('p, li, h1, h2, h3, h4');
            
            let results = [];
            
            // Search in links
            allLinks.forEach(link => {
                const text = link.textContent.toLowerCase();
                if (text.includes(query)) {
                    results.push({
                        type: 'link',
                        text: link.textContent,
                        element: link,
                        context: link.parentElement.textContent.substring(0, 150)
                    });
                }
            });
            
            // Search in text content
            allText.forEach(el => {
                const text = el.textContent.toLowerCase();
                if (text.includes(query) && !results.some(r => r.element === el)) {
                    const index = text.indexOf(query);
                    const start = Math.max(0, index - 50);
                    const end = Math.min(text.length, index + 100);
                    results.push({
                        type: 'text',
                        text: el.textContent.substring(start, end),
                        element: el
                    });
                }
            });
            
            // Limit results
            results = results.slice(0, 20);
            
            if (results.length === 0) {
                searchResults.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No results found</div>';
                return;
            }
            
            results.forEach(result => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'search-result-item';
                
                const highlightedText = result.text.replace(
                    new RegExp(`(${query})`, 'gi'),
                    '<strong>$1</strong>'
                );
                
                resultDiv.innerHTML = `
                    <div style="font-size: 0.9em; color: #667eea; margin-bottom: 5px;">
                        ${result.type === 'link' ? 'üîó Link' : 'üìÑ Text'}
                    </div>
                    <div>${highlightedText}...</div>
                `;
                
                resultDiv.addEventListener('click', () => {
                    result.element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    closeSearch();
                    
                    // Highlight briefly
                    result.element.style.backgroundColor = '#ffeb3b';
                    setTimeout(() => {
                        result.element.style.backgroundColor = '';
                    }, 2000);
                });
                
                searchResults.appendChild(resultDiv);
            });
        }

        // ======================
        // INITIALIZE GAME
        // ======================
        const game = new GameController();
        game.initialize();
        initializeSearch();

        function startNewGame() {
            clearUrl();
            location.reload();
        }

        function retryGame() {
            if (!gameState.startPage || !gameState.targetPage) {
                return;
            }
            
            // Close modal first
            const modal = document.getElementById('win-modal');
            modal.classList.remove('active');
            
            const start = gameState.startPage;
            const target = gameState.targetPage;
            const difficulty = gameState.difficulty;
            
            gameState.currentPage = start;
            gameState.clickCount = 0;
            gameState.totalClicks = 0;
            gameState.visitedPages = new Set([start]);
            gameState.path = [start];
            gameState.startTime = Date.now();
            gameState.elapsedTime = 0;
            gameState.hasWon = false;
            gameState.gaveUp = false;
            gameState.difficulty = difficulty;
            
            updateUrl(
                start,
                target,
                start,
                0,
                0,
                [start],
                [start],
                gameState.startTime
            );
            
            location.reload();
        }
    </script>
</body>
</html>
